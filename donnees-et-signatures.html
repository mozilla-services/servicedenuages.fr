<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Service de nuages, ">

        <link rel="alternate"  href="http://www.servicedenuages.fr/feeds/all.atom.xml" type="application/atom+xml" title="Service de nuages Full Atom Feed"/>

        <title>Garantir l'int√©grit√© des donn√©es via des signatures // Service de nuages // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://www.servicedenuages.fr/theme/css/pure.css">
    <link rel="stylesheet" href="http://www.servicedenuages.fr/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <h5>Publi√©</h5>
                <p title="~645 mots">~3mn de lecture üïë</p>
                <p>mer. 26 ao√ªt 2015</p>
                <a href="/">&larr;Liste des articles</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Garantir l'int√©grit√© des donn√©es via des signatures</h1>
                </header>
            </section>
                        <p><a href="http://www.servicedenuages.fr/en/data-signature">Read the English version</a></p>
            <p>Dans le cadre du projet <a class="reference external" href="https://wiki.mozilla.org/Firefox/Go_Faster">Go Faster</a>, nous souhaitons distribuer des
mises √† jour de parties de <em>Firefox</em> de mani√®re s√©par√©e des mises √† jour majeures
(qui ont lieu toutes les 6 semaines).</p>
<p>Les donn√©es que nous souhaitons mettre √† jour sur les clients sont multiples.
Entre autres, nous souhaitons g√©rer <a class="reference external" href="https://blog.mozilla.org/security/2015/03/03/revoking-intermediate-certificates-introducing-onecrl/">la mise √† jour des listes de r√©vocation
(CRL) de certificats SSL</a>.</p>
<p>Il est √©videmment n√©cessaire de s'assurer que les donn√©es qui sont t√©l√©charg√©es
sur les client sont l√©gitimes : que personne ne tente d'invalider des
certificats alors qu'ils sont valides, et que l'ensemble des mises √† jour sont
bel et bien r√©cup√©r√©es sur le client.</p>
<p>La signature garantit qu'une mise √† jour contient tous les enregistrements, mais il
est toujours possible de bloquer l'acc√®s au service (par exemple avec le <em>china
great firewall</em>).</p>
<p>Ce m√©canisme fonctionne pour les listes de certificats √† r√©voquer, mais pas
uniquement. Nous comptons r√©utiliser ce m√™me fonctionnement dans le futur pour
la mise √† jour d'autres parties de Firefox, et vous pouvez √©galement en tirer
parti pour d'autres cas d'utilisation.</p>
<p>Nous souhaitons utiliser <a class="reference external" href="https://kinto.readthedocs.org">Kinto</a> afin
de distribuer ces jeux de donn√©es. Un des avantages est que l'on peut
facilement <em>cacher</em> les collections derri√®re un CDN.</p>
<p>Par contre, nous ne souhaitons pas que les clients fassent
confiance aveugl√©ment, ni au serveur Kinto, ni au CDN.</p>
<p>Effectivement, un attaquant, contr√¥lant l'un ou l'autre, pourrait
alors envoyer les mises √† jour qu'il souhaite √† l'ensemble des clients
ou supprimer des certificats r√©voqu√©s. Imaginez le carnage !</p>
<p>Afin de r√©soudre ce probl√®me, consid√©rons les conditions suivantes:</p>
<ul class="simple">
<li>La personne qui a le pouvoir de mettre √† jour les CRL (<em>l'updater</em>)
a acc√®s √† une cle de signature (ou mieux, <a class="reference external" href="https://fr.wikipedia.org/wiki/Hardware_Security_Module">un HSM</a>) qui lui permet de
signer la collection;</li>
<li>Le pendant public de ce certificat est stock√© et distribu√© dans Firefox;</li>
<li>Le <em>hashing</em> et la <em>signature</em> sont faits c√¥t√© client pour √©viter certains
vecteurs d'attaque (si un attaquant a la main sur le serveur Kinto par
exemple).</li>
</ul>
<p>Le chiffrement √† sens unique, aussi appell√© <em>hashing</em> est un moyen de toujours
obtenir le m√™me r√©sultat √† partir de la m√™me entr√©e.</p>
<div class="section" id="premier-envoi-de-donnees-sur-kinto">
<h2>Premier envoi de donn√©es sur Kinto</h2>
<p>L'ensemble des donn√©es est r√©cup√©r√© depuis une source <em>s√©curis√©e</em> puis mis dans
une collection JSON. Chaque √©l√©ment contient un identifiant unique g√©n√©r√© sur
le client.</p>
<p>Par exemple, un enregistrement peut ressembler √† :</p>
<div class="highlight"><pre><span class="p">{</span><span class="s2">"id"</span><span class="o">:</span> <span class="s2">"b7dded96-8df0-8af8-449a-8bc47f71b4c4"</span><span class="p">,</span>
 <span class="s2">"fingerprint"</span><span class="o">:</span> <span class="s2">"11:D5:D2:0A:9A:F8:D9:FC:23:6E:5C:5C:30:EC:AF:68:F5:68:FB:A3"</span><span class="p">}</span>
</pre></div>
<p>Le <em>hash</em> de la collection est ensuite calcul√©, sign√© puis envoy√© au serveur
(voir plus bas pour les d√©tails).</p>
<p>La signature est d√©port√©e sur un service qui ne s'occupe que de √ßa, puisque la
s√©curit√© du certificat qui s'occupe des signatures est extr√™mement importante.</p>
</div>
<div class="section" id="comment-verifier-l-integrite-des-donnees">
<h2>Comment v√©rifier l'int√©grit√© des donn√©es ?</h2>
<p>Premi√®rement, il faut r√©cup√©rer l'ensemble des enregistrements pr√©sents sur
le serveur, ainsi que le <em>hash</em> et la signature associ√©e.</p>
<p>Ensuite, v√©rifier la signature du <em>hash</em>, pour s'assurer que celui-ci provient
bien d'un tiers de confiance.</p>
<p>Finalement, recalculer le <em>hash</em> localement et valider qu'il correspond bien √†
celui qui a √©t√© sign√©.</p>
</div>
<div class="section" id="ajouter-de-nouvelles-donnees">
<h2>Ajouter de nouvelles donn√©es</h2>
<p>Pour l'ajout de nouvelles donn√©es, il est n√©cessaire de s'assurer que les
donn√©es que l'on a localement sont valides avant de faire quoi que ce soit
d'autre.</p>
<p>Une fois ces donn√©es valid√©es, il suffit de proc√©der comme la premi√®re fois, et
d'envoyer √† nouveau le <em>hash</em> de la collection au serveur.</p>
</div>
<div class="section" id="comment-calculer-ce-hash">
<h2>Comment calculer ce hash ?</h2>
<p>Pour calculer le <em>hash</em> de la collection, il est n√©cessaire :</p>
<ol class="arabic simple">
<li>D'ordonner l'ensemble des √©l√©ments de la collection (par leur id) ;</li>
<li>Pour chaque √©l√©ment, s√©rialiser les champs qui nous int√©ressent (les
concat√©ner cl√© + valeur)</li>
<li>Calculer le <em>hash</em> depuis la s√©rialisation.</li>
</ol>
<p>Nous sommes encore incertains de la mani√®re dont le hash va √™tre calcul√©. Les <a class="reference external" href="https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41">JSON Web Signature</a> semblent
une piste int√©ressante. En attendant, une implementation na√Øve en python
pourrait ressembler √† ceci :</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
   <span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"b7dded96-8df0-8af8-449a-8bc47f71b4c4"</span><span class="p">,</span>
    <span class="s">"fingerprint"</span><span class="p">:</span> <span class="s">"11:D5:D2:0A:9A:F8:D9:FC:23:6E:5C:5C:30:EC:AF:68:F5:68:FB:A3"</span><span class="p">},</span>
   <span class="p">{</span><span class="s">"id"</span><span class="p">:</span> <span class="s">"dded96b7-8f0d-8f8a-49a4-7f771b4c4bc4"</span><span class="p">,</span>
    <span class="s">"fingerprint"</span><span class="p">:</span> <span class="s">"33:6E:5C:5C:30:EC:AF:68:F5:68:FB:A3:11:D5:D2:0A:9A:F8:D9:FC"</span><span class="p">}]</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="n">collection_hash</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
<p>Enfin, un sch√©ma pour r√©sumer !</p>
<img alt="Schema r√©sumant le processus de signature de la collection." class="align-center" src="http://www.servicedenuages.fr/images/kinto-signing.jpg" style="width: 600px; height: auto; max-width: 100%;"/>
</div>

            <div class="hr"></div>
            <a href="#" class="go-top">Revenir au d√©but</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "servicedenuages"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div><footer class="footer">
    <p>&copy; Service de nuages &ndash;
        D√©velopp√© avec <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        et <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.notmyidea.org/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.notmyidea.org/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
  <script src="http://www.servicedenuages.fr/theme/js/instantclick.min.js" data-no-instant></script>
  <script data-no-instant>InstantClick.init();</script>
</body>
</html>