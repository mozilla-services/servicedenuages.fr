<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Service de nuages, ">

        <link rel="alternate"  href="http://www.servicedenuages.fr/feeds/all.atom.xml" type="application/atom+xml" title="Service de nuages Full Atom Feed"/>

        <title>Survoler les bugs avec Kinto // Service de nuages // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://www.servicedenuages.fr/theme/css/pure.css">
    <link rel="stylesheet" href="http://www.servicedenuages.fr/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <h5>Publi√©</h5>
                <p title="~2119 mots">~9mn de lecture üïë</p>
                <p>jeu. 01 septembre 2016</p>
                <a href="/">&larr; Liste des articles</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Survoler les bugs avec Kinto</h1>
                        <p class="post-meta">                                <a class="post-category" href="http://www.servicedenuages.fr/tag/mozilla.html">mozilla</a>
                        </p>
                </header>
            </section>
                        <p><a href="http://www.servicedenuages.fr/en/jedit-bugs-getting-off-the-ground">Read the English version</a></p>
            <p>Voici un article r√©dig√© par <a href="https://github.com/elelay">Eric Le Lay</a> sur son utilisation de Kinto.</p>
<h2>Introduction</h2>
<p>Connaissez-vous <a href="http://jedit.org">jEdit</a> ‚Äî <em>l'√©diteur de texte des d√©veloppeurs</em> ?<br>
C'est un √©diteur de texte multi-plateforme, √©crit en java, disposant de nombreux plugins.
Je participe √† son d√©veloppement depuis une dizaine d'ann√©es.
Nous l'h√©bergeons sur Sourceforge ; le code principal est sous <em>Subversion</em>.</br></p>
<p>Nous sommes b√©n√©voles et le maintenons sur notre temps libre.
Pour ma part, je n'ai pas toujours acc√®s √† internet pendant les vacances. Ou via un c√¢ble Ethernet dans une pi√®ce sombre
et surchauff√©e. Tout √ßa pour dire que j'aime avoir un maximum de choses sous la main hors-ligne :</p>
<ul>
<li>sources et doc de la plateforme java : pas de probl√®me avec les packages <code>openjdk7-doc</code> et <code>openjdk7-src</code> ;</li>
<li>sources de jEdit et des plugins : avec git-svn j'ai le code et son historique ;</li>
<li><strong>bugs et feature requests : oups!</strong></li>
</ul>
<p>Nous avons 1100 tickets ouverts et 7600 clos. Tout √ßa n'est pas disponible hors-ligne. √áa doit changer !</p>
<h3>Comment obtenir une archive des tickets ?</h3>
<p>Sourceforge permet aux admins de t√©l√©charger une archive du projet, dont les tickets.
Actuellement un script les convertit en un paquet de fichiers HTML avec un peu de javascript pour la navigation.
Le r√©sultat (fichiers HTML pour un usage en-ligne et archive <a href="http://jedit.org/trackers/Export.tgz">t√©l√©chargeable</a>)
est d√©ploy√© via rsync sur <a href="http://jedit.org/trackers/">jedit.org/trackers</a>.
Pour limiter le volume, seuls les tickets ouverts sont disponibles.</p>
<p>La g√©n√©ration de l'archive du projet par Sourceforge prend plusieurs minutes, c'est pourquoi je la lance au plus une fois
par semaine.
Pour les utilisateurs, ce n'est pas tr√®s pratique, car il faut qu'ils t√©l√©chargent une nouvelle archive pour avoir une
vue √† jour des tickets. Elle peut avoir une semaine de retard : peut mieux faire.</p>
<h3>Objectifs</h3>
<ul>
<li>je voudrais permettre la mise √† jour incr√©mentale des tickets ;</li>
<li>je voudrais enrichir la visualisation des tickets : possibilit√© de recherche am√©lior√©e ;
   peut-√™tre permettre la modification hors-ligne ;</li>
<li>je voudrais essayer Kinto :-).</li>
</ul>
<h2>Mes premiers pas avec Kinto</h2>
<p>J'ai entendu parler de Kinto par R√©my et Alexis. Comme avec couchdb/pouchdb, il est possible de synchroniser
la base de donn√©es entre le serveur (Kinto) et le navigateur web (kinto.js). Kinto.js stocke les donn√©es dans IndexedDB
donc il est possible de manipuler une base relativement volumineuse.</p>
<p>Chaque utilisateur peut cr√©er ses propres collections (l'√©quivalent des tables SQL) Kinto. Il est m√™me possible de g√©rer les
permissions document par document (l'√©quivalent des lignes SQL).</p>
<h3>Le tutoriel : ToDo list</h3>
<p>J'ai commenc√© par le
<a href="http://kintojs.readthedocs.io/en/latest/tutorial/">tutoriel</a>. Il pr√©sente bien les op√©rations: cr√©er des documents, les
afficher, les modifier, synchroniser avec le serveur. Il s'appuie sur le serveur Kinto de test de mozilla : donc un
obstacle de moins pour d√©marrer.</p>
<h3>Des tickets au lieu des t√¢ches</h3>
<p>Je suis pass√© √† un serveur kinto local pour mes tests : il est d√©ployable tr√®s facilement via docker.
Si vous envisagez d'importer des documents, utilisez tout de suite le backend PostgreSQL
(aussi facile √† mettre en place, avec docker-compose ;
tout est <a href="http://kinto.readthedocs.io/en/stable/tutorials/install.html#using-docker-compose">expliqu√©</a>).
Le backend en RAM pose des <a href="https://github.com/Kinto/kinto/issues/759">probl√®mes</a> lors d'import batch en parall√®le (ce
qui se produit si vous importez depuis un <a href="https://github.com/elelay/jedit-trackers-kinto/blob/master/transform.js">script</a>
node.js utilisant <a href="https://www.npmjs.com/package/request">request</a>).</p>
<p>Une fois les tickets import√©s, l'application web n'a plus qu'√† les r√©cup√©rer via la synchronisation kinto.js et les
afficher.</p>
<h3>Recherche locale avec kinto.js</h3>
<p>La recherche locale avec kinto.js n'est pas aussi d√©velopp√©e que la recherche
<a href="http://kinto.readthedocs.io/en/stable/api/1.x/filtering.html">sur le serveur</a> :
seule la conjonction de <code>cl√©: [valeur1, valeur2, ...]</code> est support√©e. La recherche sur les champs <code>id</code>, <code>_status</code> et <code>last_modified</code>
est acc√©l√©r√©e par un index (code <a href="https://github.com/Kinto/kinto.js/blob/f48ea470ddb2c6398acc386439043e6cae8bffe4/src/adapters/IDB.js#L325">ici</a>).
Ensuite, tous les documents sont charg√©s et retourn√©s sous forme de tableau puis filtr√©s selon les crit√®res restants.
Le filtrage selon des crit√®res plus complexes se fait par l'application sur le r√©sultat de <code>list()</code>.
Dans les cas de petites collections c'est simple et de bon go√ªt mais avec 8000 documents la recherche
devient un peu lente.</p>
<p>Exemple de recherche <em>complexe</em> par mot cl√© (champ de texte) :</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">filterByKeyword</span><span class="p">(</span><span class="nx">keyword</span><span class="p">){</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">summary</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">keyword</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">search</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">keyword</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"query"</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">tickets</span>
    <span class="p">.</span><span class="nx">list</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">filterByKeyword</span><span class="p">(</span><span class="nx">keyword</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// on submit</span>
<span class="nx">search</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">render</span><span class="p">);</span>
</pre></div>
<h2>Architecture</h2>
<p>J'h√©berge mon serveur kinto sur un serveur C1 chez scaleway. Il contient deux collections :</p>
<ul>
<li>tickets, pour les tickets ouverts ou r√©cemment ferm√©s ;</li>
<li>oldTickets, pour les tickets ferm√©s avant 2016.</li>
</ul>
<p>J'utilise l'id des tickets chez Sourceforge <a href="http://kintojs.readthedocs.io/en/latest/api/#custom-id-generation-using-an-id-schema">plut√¥t qu'une id auto-g√©n√©r√©e</a>.
Je peux ainsi mettre √† jour la base facilement √† partir des infos de Sourceforge (pas besoin de rechercher le document
chez kinto avant de le mettre √† jour puisque je connais l'id).</p>
<p>Les clients sont des applications web.</p>
<p>Un script de mise √† jour reporte les modifications de Sourceforge dans la base.</p>
<p>La machine √©tant un serveur ARM sous debian Jessie, quelques am√©nagements ont √©t√© n√©cessaires (d√©tails sur le
<a href="https://github.com/Kinto/kinto/wiki">wiki kinto</a>).</p>
<h2>Client kinto.js</h2>
<p>Mon objectif √©tait d'abord d'en apprendre le maximum sur kinto.js. J'ai bien aim√© le cot√© vanilla du tutoriel (pas de
d√©pendance √† n frameworks) et suis rest√© sur cette simplicit√© :</p>
<ul>
<li>le CSS de bootstrap, les ic√¥nes de fontawesome</li>
<li>quelques utilitaires : moment, lodash,</li>
<li>datatables (apr√®s avoir fait ma propre gestion de table, mais voulant d√©plier certaines lignes de la table et ayant trouv√©
   un <a href="https://datatables.net/examples/server_side/row_details.html">exemple tout pr√™t</a>).</li>
</ul>
<p><img alt="Capture d'√©cran de l'application" src="http://www.servicedenuages.fr/images/jedit-trackers-with-kinto-app.png" style="width: 990px; height: auto; max-width: 100%;"/></p>
<h2>√âtat initial</h2>
<p>Lorsque vous acc√©dez pour la premi√®re fois √† l'<a href="https://trackers.elelay.fr/trackers.html">application</a>, un panneau vous
est pr√©sent√© proposant de r√©cup√©rer les tickets, dont √©ventuellement les vieux tickets.</p>
<p>Petite astuce pour d√©terminer si c'est la premi√®re fois :</p>
<div class="highlight"><pre><span></span><span class="nx">tickets</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">getLastModified</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hasDB</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">noDB</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>Pour afficher le nombre de tickets sur le serveur avant de les r√©cup√©rer, il faut descendre dans le package
<a href="https://github.com/Kinto/kinto-http.js">kinto-http</a>.</p>
<p>Le code correspondant (bient√¥t simplifi√©) :</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">fetchTotalRecords</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">etag</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">headers</span><span class="p">[</span><span class="s2">"Authorization"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Basic "</span> <span class="o">+</span> <span class="nx">btoa</span><span class="p">(</span><span class="s2">"token:tr0ub4d@ur"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">api</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s2">"/buckets/"</span> <span class="o">+</span> <span class="nx">bucket</span> <span class="o">+</span> <span class="s2">"/collections/"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">"/records"</span> <span class="o">+</span> <span class="p">(</span><span class="nx">etag</span> <span class="o">?</span> <span class="p">(</span><span class="s2">"?_since="</span> <span class="o">+</span> <span class="nx">etag</span><span class="p">)</span> <span class="o">:</span> <span class="s2">""</span><span class="p">),</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s2">"HEAD"</span><span class="p">,</span>
        <span class="nx">headers</span>
    <span class="p">},</span> <span class="p">{</span>
        <span class="nx">raw</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"RES"</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"total-records"</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">tickets</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">getLastModified</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">lastMod</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">tickets</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">bucket</span><span class="p">(</span><span class="nx">tickets</span><span class="p">.</span><span class="nx">bucket</span><span class="p">).</span><span class="nx">collection</span><span class="p">(</span><span class="nx">tickets</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">fetchTotalRecords</span><span class="p">(</span><span class="nx">api</span><span class="p">,</span> <span class="nx">tickets</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">tickets</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">lastMod</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">renderTicketCount</span><span class="p">);</span>
</pre></div>
<p>Cette m√©thode fonctionne aussi pour d√©terminer s'il y a eu du nouveau sur le serveur (<a href="http://kinto.readthedocs.io/en/latest/api/1.x/filtering.html#polling-for-changes">via l'ETag</a>). Le serveur kinto ne
r√©pond pas instantan√©ment. Il faudrait peut-√™tre passer l'etag en <code>If-None-Match</code> en plus de <code>since</code> pour acc√©l√©rer les choses.</p>
<h2>Recherche</h2>
<p>Pour la recherche en texte libre cot√© client, j'ai utilis√© <a href="http://lunrjs.com/">lunr</a>. Il construit un index
√† la Lucene, et permet ensuite de rechercher dans cet index. L'index est s√©rialis√© et enregistr√© comme un document
d'une collection kinto.js cliente pour √™tre r√©utilis√© √† la prochaine visite.</p>
<p>La recherche dans l'index retourne un tableau d'id de documents depuis lequel j'extrais les documents, avant de filtrer
ce petit tableau avec les autres crit√®res. Cela a acc√©l√©r√© les choses par rapport √† la premi√®re version de l'application,
dans laquelle je commen√ßais toujours la recherche par un <code>tickets.list()</code>, qui retournait tous les documents.</p>
<p>Pour rechercher <em>hello</em> dans l'index en m√©moire :</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nx">index</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
   <span class="p">[{</span><span class="s2">"ref"</span><span class="o">:</span><span class="s2">"52a4d8cb27184667e3400f42"</span><span class="p">,</span><span class="s2">"score"</span><span class="o">:</span><span class="mf">0.019459983366287688</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">"ref"</span><span class="o">:</span><span class="s2">"5690ff3f24b0d96f08df7d6a"</span><span class="p">,</span><span class="s2">"score"</span><span class="o">:</span><span class="mf">0.013994677485991343</span><span class="p">},</span>
    <span class="p">...</span>
   <span class="p">]</span>
</pre></div>
<p>Pour obtenir une promesse d'un objet <code>{ data: ['tableau', 'de', 'tickets', 'contenant', 'texteLibre'] }</code>:</p>
<div class="highlight"><pre><span></span><span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">index</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">texteLibre</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">tickets</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">hit</span><span class="p">.</span><span class="nx">ref</span><span class="p">);</span>
<span class="p">})).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">allRes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">allRes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="p">})</span>
    <span class="p">};</span>
<span class="p">});</span>
</pre></div>
<p>Dans ce code, tous les documents sont r√©cup√©r√©s d'IndexedDB en parall√®le via leur Id (<code>collection.get()</code>).
C'est rapide car IndexedDB est optimis√© pour l'acc√®s par cl√©, mais il serait peut‚Åª√™tre plus efficace d'utiliser
<code>tickets.list({filters: {id: ['tableau', 'des', 'ids']}})</code> pour limiter le nombre de requ√™tes.</p>
<h2>Affichage d'un ticket</h2>
<p>L'application est con√ßue pour √™tre multi-onglet, permettre la navigation dans l'historique et la cr√©ation de marques pages.
Pour cela, l'√©tat est stock√© dans l'url et les recherches entra√Ænent des appels √† <code>pushState()</code>.</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">state</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">encodeState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"#"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">state</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">applyState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"search"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">filter</span><span class="p">;</span>
    <span class="nx">search</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">saveState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="s2">"jEdit Trackers"</span><span class="p">,</span> <span class="nx">encodeState</span><span class="p">(</span><span class="nx">state</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">hashIsTicket</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^#[a-z0-9-]+$/</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"popstate"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// called on browser history navigation</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
        <span class="nx">applyState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">hashIsTicket</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// show this ticket</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// show search interface</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>On peut afficher un ticket dans un autre onglet en cliquant sur <em>Ouvrir</em> dans un r√©sultat de recherche.
Rien de bien compliqu√© : l'id est mise dans le hash de l'url et l'application interpr√®te ce hash au chargement.</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">restoreInitialState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^#[a-z0-9-]+$/</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">showTicket</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">"#%7B"</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"invalid state in hash"</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">);</span>
            <span class="nx">state</span> <span class="o">=</span> <span class="nx">defaultState</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">applyState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="o">=</span> <span class="nx">defaultState</span><span class="p">();</span>
        <span class="nx">applyState</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">restoreInitialState</span><span class="p">();</span> <span class="c1">// to restore state from bookmark or link at page load</span>
</pre></div>
<h1>Mises √† jour</h1>
<p>Lorsqu'un ticket est modifi√© cot√© Sourceforge il faut mettre √† jour le document correspondant dans Kinto.
Je le fais via un programme cot√© serveur. </p>
<h2>updater.py</h2>
<p>Il n'est pas possible d'obtenir les modifications de tickets Sourceforge en temps r√©el via les technologies web.</p>
<p>Quelques id√©es pour les obtenir :</p>
<ol>
<li>interroger p√©riodiquement le flux RSS de chaque tracker (limit√© √† 10 tickets donc on peut rater des mises √†
 jour si le script ne s'ex√©cute pas pendant un moment) ;</li>
<li>interroger p√©riodiquement l'API REST de chaque tracker, en demandant les tickets modifi√©s depuis la derni√®re
 fois (d√©lai &lt; p√©riode de polling) ;</li>
<li>s'abonner √† la mailing list jedit-devel et les r√©cup√©rer avec un client pop3 (d√©lai &lt; 1 minute).</li>
</ol>
<p>J'ai choisi la solution 2. Le script
<a href="https://github.com/elelay/jedit-trackers-kinto/blob/master/updater.py">updater.py</a></p>
<ol>
<li>r√©cup√®re la liste des trackers chez Sourceforge,</li>
<li>r√©cup√®re de kinto la date de derni√®re mise √† jour (document dans une collection <code>updater</code>),</li>
<li>interroge Sourceforge sur les tickets modifi√©s depuis cette date,</li>
<li>pousse les mises √† jour dans les collections <code>tickets</code> et <code>oldTickets</code>.</li>
</ol>
<p>Les tickets sont d√©j√† en JSON, avec un minimum de mapping √† faire (r√©cup√©rer les commentaires via une seconde requ√™te
√† Sourceforge).</p>
<h2>Notifications client</h2>
<p>Kinto semble disposer d'un m√©canisme de notification via
<a href="http://kinto.readthedocs.io/en/latest/tutorials/notifications-websockets.html">websockets</a> mais je ne l'ai pas explor√©.</p>
<p>Les clients interrogent le serveur kinto pour les nouveaux tickets toutes les minutes. Lorsqu'il y en a, une
notification proposant de synchroniser la base s'affiche en haut √† droite de l'application.</p>
<p>Suite √† la synchronisation, je mets √† jour l'index lunr avec les documents modifi√©s/ajout√©s/supprim√©s (<code>index.add(document)</code>, <code>index.remove(document)</code>).</p>
<p>Les compteurs de tickets affich√©s sur les boutons (rat√©s, bugs ouverts) sont aussi recalcul√©s √† cette occasion
et stock√©s dans une collection client. S'il n'y a pas de suppressions, je peux les mettre √† jour incr√©mentalement,
sinon, il faut re-parcourir la collection pour les calculer.</p>
<h1>Conclusion</h1>
<h2>Ai-je bien fait d'essayer Kinto ?</h2>
<p><strong>Oui, certainement</strong>. C'est une bonne plateforme pour mon application. Ce n'est cependant pas une solution cl√© en main
comme <a href="https://www.meteor.com/">meteor</a>. Il faut donc l'associer √† d'autres librairies pour avoir une application compl√®te.
D'un autre cot√©, le d√©ploiement est simple et le d√©roulement du programme est facile √† suivre.</p>
<p>Les performances sont correctes (l'import batch des 8000 tickets fait tourner mon petit serveur pendant 5 minutes)
et le syst√®me est ouvert.</p>
<p>Je me suis un peu compliqu√© la vie en s√©parant les tickets en deux collections, mais ne charger que les tickets r√©cents
all√®ge vraiment l'application.</p>
<h2>Am√©lioration pr√©vues</h2>
<p>J'ai pass√© 3 semaines √† explorer Kinto et il reste encore des choses √† tester. Je suis √©galement loin d'une application termin√©e.</p>
<p>Quelques pistes :</p>
<p><strong>Modifications des tickets</strong><br>
Je voudrais qu'on puisse modifier les tickets depuis l'application, plut√¥t que de renvoyer vers Sourceforge.
Les modifications pourraient √™tre temporairement stock√©es dans kinto.js en attente de r√©seau.</br></p>
<p>La voie est libre depuis la correction d'un <a href="https://sourceforge.net/p/forge/site-support/13403/">petit bug</a>
qui emp√™chait d'interroger l'API Sourceforge en CORS depuis la France, mais √ßa repr√©sente pas mal de code pour
l'interface utilisateur. J'explorerai <a href="https://github.com/Kinto/formbuilder">FormBuilder</a> avant de coder ma
propre solution. Sans aller jusque l√†, il pourrait √™tre int√©ressant de permettre aux utilisateurs de tagger, mettre en
favoris, suivre, certains tickets (stockage dans kinto).</p>
<p><strong>Interface Utilisateur</strong>
L'interface est largement am√©liorable. J'envisage √©galement de restructurer le code en m'appuyant sur react, vu qu'il existe
du <a href="https://github.com/Kinto/kinto-react-boilerplate">boilerplate</a> et <a href="https://github.com/Kinto/kinto-admin">kinto-admin</a>
comme source d'inspiration.</p>
<p><strong>Pi√®ces jointes</strong>
Tous les tickets sont accessibles hors-ligne, mais pas les pi√®ces-jointes (comme le log contenant la
trace d'ex√©cution permettant de comprendre le bug). Nous ne sommes donc pas encore √† du 100% hors-ligne. J'aimerai
distribuer ces pi√®ces-jointes, peut-√™tre avec le m√©canisme
d'<a href="http://www.servicedenuages.fr/kinto-file-attachment">Attachments</a> de kinto. Les pi√®ces-jointes des tickets r√©cents font 10Mo,
celles des anciens tickets 18Mo : √ßa semble donc faisable.</p>
<p><strong>Recherche texte libre</strong>
Je n'utilise lunr.js que de mani√®re tr√®s basique : indexation du titre et de la description. Mais l'index est
d√©j√† tr√®s gros et lent √† (d√©)s√©rialiser depuis IndexedDB. J'h√©site entre l'enrichir, permettant une recherche sur <a href="https://github.com/olivernn/lunr.js/issues/125">tous
les champs</a> ou d√©finir mon langage de requ√™te et jouer sur des index que
je maintiendrai moi-m√™me.</p>
<p>L'indexation pourrait se faire dans un WebWorker, pour ne pas bloquer l'application.</p>
<p><strong>Performances</strong>
Les tickets pourraient √™tre index√©s par num√©ro (ils ne sont pas uniques au sein d'un projet, mais au sein d'un tracker) pour acc√©l√©rer
ce type de recherche. De m√™me, indexer par les autres crit√®res de recherche pr√©d√©finis acc√©l√®rerait les choses.</p>
<p>Je peux g√©rer des index manuels (un document par index, contenant un objet associant chaque valeur possible de la cl√©
√† un tableau d'id). Alors, rechercher tous les bugs ouverts reviendrait √† </p>
<div class="highlight"><pre><span></span><span class="nx">indexes</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"bug"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">resInd</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">ind</span> <span class="o">=</span> <span class="nx">resInd</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span> <span class="c1">// ind = { open : ["id1", "id2", ...], ...}</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">((</span><span class="nx">ind</span><span class="p">.</span><span class="nx">open</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">tickets</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">tickets</span><span class="p">)))</span>
                  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">multiRes</span><span class="p">){</span>
                      <span class="k">return</span> <span class="nx">multiRes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">;})</span>
                  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<h2>Merci !</h2>
<p>Je tiens √† remercier l'√©quipe travaillant autour de Kinto pour leur gentillesse
et leur ouverture : accessibles sur IRC (#kinto) et Slack, ils encouragent la cr√©ation de tickets, de PR.
De nombreuses sont m√™me accept√©es ;-)</p>
<p>Le code est disponible sur github: <a href="https://github.com/elelay/jedit-trackers-kinto">elelay/jedit-trackers-kinto</a>.<br>
Il tourne sur <a href="http://trackers.elelay.fr/trackers.html">trackers.elelay.fr</a>.<br>
Vos retours sont les bienvenus via IRC (elelay) ‚Äî Issues et PR, sait-on jamais...</br></br></p>
<!-- :wrap=hard:noTabs=true:tabSize=4:indentSize=4: -->
            <div class="hr"></div>
            <a href="#" class="go-top">Revenir au d√©but</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "servicedenuages"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div><footer class="footer">
    <p>&copy; Service de nuages &ndash;
        D√©velopp√© avec <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        et <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.notmyidea.org/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.notmyidea.org/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
  <script src="http://www.servicedenuages.fr/theme/js/instantclick.min.js" data-no-instant></script>
  <script data-no-instant>InstantClick.init();</script>
</body>
</html>